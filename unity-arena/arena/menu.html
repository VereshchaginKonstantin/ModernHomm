<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unity Arena - Главное меню | ModernHomm</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            background: linear-gradient(45deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header p {
            color: #888;
            font-size: 1.2rem;
        }

        .container {
            max-width: 800px;
            width: 100%;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f39c12;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Player Selection */
        .player-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 600px) {
            .player-section {
                grid-template-columns: 1fr;
            }
        }

        .player-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .player-card h3 {
            margin-bottom: 15px;
            color: #f39c12;
        }

        .player-card.you h3 {
            color: #2ecc71;
        }

        .player-card.opponent h3 {
            color: #e74c3c;
        }

        select, input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1rem;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select:hover, input:hover {
            border-color: #f39c12;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #f39c12;
            box-shadow: 0 0 10px rgba(243, 156, 18, 0.3);
        }

        option {
            background: #1a1a2e;
            color: #fff;
        }

        .player-stats {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 10px;
        }

        .player-units {
            text-align: left;
            margin-top: 15px;
            font-size: 0.85rem;
        }

        .player-units .unit-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Field Selection */
        .field-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .field-option {
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .field-option:hover {
            border-color: #f39c12;
            transform: translateY(-3px);
        }

        .field-option.selected {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.2);
        }

        .field-option .size {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f39c12;
        }

        .field-option .desc {
            font-size: 0.85rem;
            color: #888;
            margin-top: 5px;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(243, 156, 18, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        /* Pending Games */
        .pending-game {
            background: rgba(231, 76, 60, 0.2);
            border: 2px solid #e74c3c;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .pending-game-info h4 {
            color: #e74c3c;
            margin-bottom: 5px;
        }

        .pending-game-info p {
            font-size: 0.9rem;
            color: #aaa;
        }

        .pending-game-actions {
            display: flex;
            gap: 10px;
        }

        .btn-accept {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 10px 25px;
            font-size: 1rem;
        }

        .btn-decline {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
            padding: 10px 25px;
            font-size: 1rem;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top-color: #f39c12;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Status Message */
        .status-message {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .status-message.success {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .status-message.error {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .status-message.info {
            background: rgba(52, 152, 219, 0.2);
            color: #3498db;
        }

        /* Links */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #888;
            text-decoration: none;
            margin-bottom: 20px;
            transition: color 0.3s;
        }

        .back-link:hover {
            color: #f39c12;
        }
    </style>
</head>
<body>
    <a href="/arena/" class="back-link">&larr; Вернуться к веб-арене</a>

    <div class="header">
        <h1>Unity Arena</h1>
        <p>Выберите противника и начните бой!</p>
    </div>

    <div class="container">
        <!-- Pending Games Section -->
        <div class="card" id="pending-section" style="display: none;">
            <h2>Вызовы на бой</h2>
            <div id="pending-games"></div>
        </div>

        <!-- Player Selection -->
        <div class="card">
            <h2>Выбор игрока</h2>
            <div class="player-section">
                <div class="player-card you">
                    <h3>Вы</h3>
                    <select id="player-select">
                        <option value="">Загрузка...</option>
                    </select>
                    <div class="player-stats" id="player-stats"></div>
                    <div class="player-units" id="player-units"></div>
                </div>
                <div class="player-card opponent">
                    <h3>Противник</h3>
                    <select id="opponent-select">
                        <option value="">Сначала выберите себя</option>
                    </select>
                    <div class="player-stats" id="opponent-stats"></div>
                    <div class="player-units" id="opponent-units"></div>
                </div>
            </div>
        </div>

        <!-- Field Selection -->
        <div class="card">
            <h2>Размер поля</h2>
            <div class="field-options">
                <div class="field-option selected" data-size="5x5">
                    <div class="size">5x5</div>
                    <div class="desc">Быстрый бой</div>
                </div>
                <div class="field-option" data-size="7x7">
                    <div class="size">7x7</div>
                    <div class="desc">Стандартный</div>
                </div>
                <div class="field-option" data-size="10x10">
                    <div class="size">10x10</div>
                    <div class="desc">Большое поле</div>
                </div>
            </div>
        </div>

        <!-- Start Battle Button -->
        <button class="btn btn-primary" id="start-battle" disabled>
            Вызвать на бой!
        </button>

        <div class="status-message" id="status-message" style="display: none;"></div>
    </div>

    <script>
        // API Base URL
        const API_BASE = '/arena/api';

        // State
        let players = [];
        let selectedPlayer = null;
        let selectedOpponent = null;
        let selectedFieldSize = '5x5';

        // DOM Elements
        const playerSelect = document.getElementById('player-select');
        const opponentSelect = document.getElementById('opponent-select');
        const playerStats = document.getElementById('player-stats');
        const playerUnits = document.getElementById('player-units');
        const opponentStats = document.getElementById('opponent-stats');
        const opponentUnits = document.getElementById('opponent-units');
        const startBattleBtn = document.getElementById('start-battle');
        const statusMessage = document.getElementById('status-message');
        const pendingSection = document.getElementById('pending-section');
        const pendingGames = document.getElementById('pending-games');

        // Field size selection
        document.querySelectorAll('.field-option').forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.field-option').forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
                selectedFieldSize = option.dataset.size;
            });
        });

        // Load players on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await loadPlayers();

            // Check for saved player ID
            const savedPlayerId = localStorage.getItem('player_id');
            if (savedPlayerId) {
                playerSelect.value = savedPlayerId;
                onPlayerSelected();
            }
        });

        // Load players from API
        async function loadPlayers() {
            try {
                const response = await fetch(`${API_BASE}/players`);
                const data = await response.json();
                players = data.players || [];

                // Populate player select
                playerSelect.innerHTML = '<option value="">Выберите себя</option>';
                players.filter(p => p.units && p.units.length > 0).forEach(player => {
                    const option = document.createElement('option');
                    option.value = player.id;
                    option.textContent = `${player.name} (${player.army_cost.toFixed(0)} стоимость)`;
                    option.dataset.player = JSON.stringify(player);
                    playerSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading players:', error);
                showStatus('Ошибка загрузки игроков', 'error');
            }
        }

        // Player selected
        playerSelect.addEventListener('change', onPlayerSelected);

        function onPlayerSelected() {
            const playerId = parseInt(playerSelect.value);
            if (!playerId) {
                selectedPlayer = null;
                playerStats.textContent = '';
                playerUnits.innerHTML = '';
                opponentSelect.innerHTML = '<option value="">Сначала выберите себя</option>';
                opponentStats.textContent = '';
                opponentUnits.innerHTML = '';
                startBattleBtn.disabled = true;
                return;
            }

            selectedPlayer = players.find(p => p.id === playerId);
            if (!selectedPlayer) return;

            // Save to localStorage
            localStorage.setItem('player_id', playerId);

            // Update player stats
            const winRate = selectedPlayer.wins + selectedPlayer.losses > 0
                ? ((selectedPlayer.wins / (selectedPlayer.wins + selectedPlayer.losses)) * 100).toFixed(0)
                : 0;
            playerStats.textContent = `Побед: ${selectedPlayer.wins} | Поражений: ${selectedPlayer.losses} (${winRate}%)`;

            // Update player units
            playerUnits.innerHTML = selectedPlayer.units.map(u =>
                `<div class="unit-row"><span>${u.unit_name}</span><span>x${u.count}</span></div>`
            ).join('');

            // Filter opponents (within 50% army cost)
            const minCost = selectedPlayer.army_cost * 0.5;
            const maxCost = selectedPlayer.army_cost * 1.5;
            const validOpponents = players.filter(p =>
                p.id !== playerId &&
                p.units && p.units.length > 0 &&
                p.army_cost >= minCost &&
                p.army_cost <= maxCost
            );

            // Populate opponent select
            opponentSelect.innerHTML = '<option value="">Выберите противника</option>';
            validOpponents.forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                const winRate = player.wins + player.losses > 0
                    ? ((player.wins / (player.wins + player.losses)) * 100).toFixed(0)
                    : 0;
                option.textContent = `${player.name} (${player.army_cost.toFixed(0)}) - ${winRate}%`;
                option.dataset.player = JSON.stringify(player);
                opponentSelect.appendChild(option);
            });

            // Check for pending games
            checkPendingGames(playerId);

            updateStartButton();
        }

        // Opponent selected
        opponentSelect.addEventListener('change', onOpponentSelected);

        function onOpponentSelected() {
            const opponentId = parseInt(opponentSelect.value);
            if (!opponentId) {
                selectedOpponent = null;
                opponentStats.textContent = '';
                opponentUnits.innerHTML = '';
                startBattleBtn.disabled = true;
                return;
            }

            selectedOpponent = players.find(p => p.id === opponentId);
            if (!selectedOpponent) return;

            // Update opponent stats
            const winRate = selectedOpponent.wins + selectedOpponent.losses > 0
                ? ((selectedOpponent.wins / (selectedOpponent.wins + selectedOpponent.losses)) * 100).toFixed(0)
                : 0;
            opponentStats.textContent = `Побед: ${selectedOpponent.wins} | Поражений: ${selectedOpponent.losses} (${winRate}%)`;

            // Update opponent units
            opponentUnits.innerHTML = selectedOpponent.units.map(u =>
                `<div class="unit-row"><span>${u.unit_name}</span><span>x${u.count}</span></div>`
            ).join('');

            updateStartButton();
        }

        function updateStartButton() {
            startBattleBtn.disabled = !selectedPlayer || !selectedOpponent;
        }

        // Check for pending games
        async function checkPendingGames(playerId) {
            try {
                const response = await fetch(`${API_BASE}/games/pending?player_id=${playerId}`);
                const data = await response.json();

                if (data.games && data.games.length > 0) {
                    pendingSection.style.display = 'block';
                    pendingGames.innerHTML = data.games.map(game => `
                        <div class="pending-game">
                            <div class="pending-game-info">
                                <h4>${game.player1_name} вызывает вас!</h4>
                                <p>Поле: ${game.field_size} | Игра #${game.game_id}</p>
                            </div>
                            <div class="pending-game-actions">
                                <button class="btn btn-accept" onclick="acceptGame(${game.game_id})">Принять</button>
                                <button class="btn btn-decline" onclick="declineGame(${game.game_id})">Отклонить</button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    pendingSection.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking pending games:', error);
            }
        }

        // Accept game
        async function acceptGame(gameId) {
            if (!selectedPlayer) return;

            try {
                const response = await fetch(`${API_BASE}/games/${gameId}/accept`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_id: selectedPlayer.id })
                });

                const data = await response.json();
                if (data.success) {
                    // Redirect to Unity game
                    window.location.href = `index.html?game_id=${gameId}&player_id=${selectedPlayer.id}`;
                } else {
                    showStatus('Ошибка: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Error accepting game:', error);
                showStatus('Ошибка принятия игры', 'error');
            }
        }

        // Decline game
        async function declineGame(gameId) {
            if (!selectedPlayer) return;
            if (!confirm('Отклонить вызов?')) return;

            try {
                const response = await fetch(`${API_BASE}/games/${gameId}/decline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ player_id: selectedPlayer.id })
                });

                const data = await response.json();
                if (data.success) {
                    checkPendingGames(selectedPlayer.id);
                    showStatus('Вызов отклонён', 'info');
                }
            } catch (error) {
                console.error('Error declining game:', error);
            }
        }

        // Start battle
        startBattleBtn.addEventListener('click', async () => {
            if (!selectedPlayer || !selectedOpponent) return;

            startBattleBtn.disabled = true;
            startBattleBtn.textContent = 'Создание игры...';

            try {
                const response = await fetch(`${API_BASE}/games/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        player1_id: selectedPlayer.id,
                        player2_name: selectedOpponent.name,
                        field_size: selectedFieldSize
                    })
                });

                const data = await response.json();
                if (data.success) {
                    showStatus('Вызов отправлен! Ожидание ответа...', 'info');

                    // Start polling for game acceptance
                    pollGameStatus(data.game_id);
                } else {
                    showStatus('Ошибка: ' + data.message, 'error');
                    startBattleBtn.disabled = false;
                    startBattleBtn.textContent = 'Вызвать на бой!';
                }
            } catch (error) {
                console.error('Error creating game:', error);
                showStatus('Ошибка создания игры', 'error');
                startBattleBtn.disabled = false;
                startBattleBtn.textContent = 'Вызвать на бой!';
            }
        });

        // Poll for game status
        let pollInterval = null;

        async function pollGameStatus(gameId) {
            pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`${API_BASE}/games/${gameId}/state`);
                    const data = await response.json();

                    if (data.status === 'in_progress') {
                        clearInterval(pollInterval);
                        // Game accepted - redirect to Unity
                        window.location.href = `index.html?game_id=${gameId}&player_id=${selectedPlayer.id}`;
                    } else if (data.status === 'cancelled' || data.status === 'declined') {
                        clearInterval(pollInterval);
                        showStatus('Вызов был отклонён', 'error');
                        startBattleBtn.disabled = false;
                        startBattleBtn.textContent = 'Вызвать на бой!';
                    }
                } catch (error) {
                    console.error('Error polling game status:', error);
                }
            }, 2000);
        }

        // Show status message
        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message ' + type;
            statusMessage.style.display = 'block';

            if (type !== 'info') {
                setTimeout(() => {
                    statusMessage.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>
